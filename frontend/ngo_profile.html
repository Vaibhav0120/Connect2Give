{% extends 'ngo_base.html' %}

{% block title %}My Profile - {{ block.super }}{% endblock %}

{% block head %}
    {{ block.super }}
    <style>
        .profile-form-container { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 2em; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
        .form-group { margin-bottom: 1.5em; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        input[type="text"], textarea { width: 100%; padding: 0.8em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .success-message { color: #155724; background-color: #D4EDDA; border: 1px solid #C3E6CB; padding: 15px; margin-bottom: 1.5em; border-radius: 5px; }
        
        /* --- STYLES FOR CROPPER MODAL & PREVIEWS --- */
        .image-upload-widget { text-align: center; }
        .image-preview-container { margin-top: 1em; }
        .image-preview { width: 150px; height: 150px; border-radius: 50%; border: 2px solid #eee; object-fit: cover; }
        .banner-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #eee; }
        .cropper-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .cropper-modal-content {
            background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 600px; border-radius: 8px;
        }
        .cropper-container { max-height: 60vh; }
        #image-to-crop { max-width: 100%; }
        .cropper-actions { text-align: right; margin-top: 15px; }
        /* --- END OF NEW STYLES --- */

        #location-map { height: 300px; margin-top: 1em; border-radius: 5px; }
        .address-group { display: flex; align-items: flex-end; gap: 10px; }
        .address-group textarea { flex-grow: 1; }
        .address-group button { width: auto; flex-shrink: 0; }
    </style>
{% endblock %}

{% block ngo_content %}
    <h2>My Profile</h2>
    <p>Use this page to update your organization's public information.</p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="success-message">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="profile-form-container">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.latitude }}
            {{ form.longitude }}

            <div class="form-grid">
                <div>
                    <div class="form-group"> {{ form.ngo_name.label_tag }} {{ form.ngo_name }} </div>
                    <div class="form-group"> {{ form.contact_person.label_tag }} {{ form.contact_person }} </div>
                </div>
                <div>
                    <div class="image-upload-widget">
                        <label for="id_profile_picture_input">Profile Picture (Logo)</label>
                        <!-- This is a trigger input, not the actual form field -->
                        <input type="file" id="id_profile_picture_input" accept="image/*" onchange="openCropper(event, 1/1, 'id_profile_picture')">
                        <div class="image-preview-container">
                            <img src="{{ form.instance.profile_picture.url|default:'https://placehold.co/150x150/EFEFEF/AAAAAA&text=Logo' }}" alt="Profile Picture" class="image-preview" id="profile_picture_preview">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 2em;">
                 <div class="image-upload-widget">
                    <label for="id_banner_image_input">Banner Image</label>
                    <input type="file" id="id_banner_image_input" accept="image/*" onchange="openCropper(event, 16/9, 'id_banner_image')">
                    <div class="image-preview-container">
                        <img src="{{ form.instance.banner_image.url|default:'https://placehold.co/600x200/EFEFEF/AAAAAA&text=Banner' }}" alt="Banner Image" class="banner-preview" id="banner_image_preview">
                    </div>
                </div>
            </div>
            
            <!-- These are the original Django form fields, now hidden. We will populate them with the cropped image data using JavaScript. -->
            <div style="display: none;">
                {{ form.profile_picture }}
                {{ form.banner_image }}
            </div>

            <hr style="margin: 2em 0;">
            <h3>Update Address and Location</h3>
            <div class="form-group">
                {{ form.address.label_tag }}
                <div class="address-group"> {{ form.address }} <button type="button" onclick="findAddressOnMap()">Find</button> </div>
            </div>
            <div id="location-map"></div>
            <small>Type an address and click "Find", or click on the map to update your location.</small>
            <br><br>
            <button type="submit">Save Changes</button>
        </form>
    </div>

    <!-- CROPPER MODAL HTML -->
    <div id="cropper-modal" class="cropper-modal">
        <div class="cropper-modal-content">
            <h3>Crop Your Image</h3>
            <div class="cropper-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="cropper-actions">
                <button type="button" onclick="closeCropper()">Cancel</button>
                <button type="button" onclick="cropAndApplyImage()" style="background-color: #28a745;">Crop & Use</button>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <!-- Map JavaScript (unchanged) -->
    <script>
        const initialLat = parseFloat("{{ form.instance.latitude|default:'28.6448'|escapejs }}");
        const initialLon = parseFloat("{{ form.instance.longitude|default:'77.2167'|escapejs }}");
        const initialZoom = parseInt("{{ form.instance.latitude|yesno:'15,11' }}");
        const map = L.map('location-map').setView([initialLat, initialLon], initialZoom);
        let marker = null;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        const latField = document.getElementById('id_latitude');
        const lonField = document.getElementById('id_longitude');
        const addressField = document.getElementById('id_address');
        if (latField.value && lonField.value) { marker = L.marker([latField.value, lonField.value]).addTo(map); }
        function updateMarkerAndFields(lat, lon, address = null) {
            latField.value = lat;
            lonField.value = lon;
            if (address) { addressField.value = address; }
            if (marker) { marker.setLatLng([lat, lon]); } else { marker = L.marker([lat, lon]).addTo(map); }
            map.setView([lat, lon], 15);
        }
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => updateMarkerAndFields(lat, lon, d.display_name || 'Could not find address'));
        });
        function findAddressOnMap() {
            const address = addressField.value;
            if (!address) { alert("Please enter an address to find."); return; }
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(r => r.json()).then(d => { if(d.length > 0){ updateMarkerAndFields(d[0].lat, d[0].lon); } else { alert("Address not found."); }});
        }
    </script>
    
    <!-- NEW CROPPER JAVASCRIPT -->
    <script>
        const modal = document.getElementById('cropper-modal');
        const image = document.getElementById('image-to-crop');
        let cropper;
        let targetInputFieldId; // e.g., 'id_profile_picture'
        let targetPreviewId;    // e.g., 'profile_picture_preview'
        let sourceFileName;

        function openCropper(event, aspectRatio, targetId) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    image.src = e.target.result;
                    modal.style.display = 'flex';
                    if(cropper) cropper.destroy(); // Destroy previous instance
                    cropper = new Cropper(image, {
                        aspectRatio: aspectRatio,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 1,
                    });
                };
                reader.readAsDataURL(input.files[0]);
                sourceFileName = input.files[0].name;
                targetInputFieldId = targetId;
                targetPreviewId = targetId + '_preview';
            }
        }

        function closeCropper() {
            modal.style.display = 'none';
            if(cropper) cropper.destroy();
        }

        function cropAndApplyImage() {
            if (!cropper) return;

            const canvas = cropper.getCroppedCanvas({
                width: 1024, // Resize for consistency and quality
                imageSmoothingQuality: 'high',
            });

            // Update the preview image on the main page
            const previewElement = document.getElementById(targetPreviewId);
            previewElement.src = canvas.toDataURL('image/jpeg');

            // Convert the cropped canvas image to a Blob, then to a File
            canvas.toBlob(function (blob) {
                // Create a new File object with a clean name
                const newFile = new File([blob], sourceFileName, { type: 'image/jpeg', lastModified: Date.now() });

                // Use the DataTransfer API to create a FileList object
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(newFile);

                // Set the files of the original hidden Django input field
                const targetInput = document.getElementById(targetInputFieldId);
                targetInput.files = dataTransfer.files;
                
                closeCropper();
            }, 'image/jpeg', 0.9); // Use 90% quality for the jpeg
        }
    </script>
{% endblock %}
