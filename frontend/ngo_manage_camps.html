{% extends 'ngo_base.html' %}

{% block title %}Manage Camps - {{ block.super }}{% endblock %}

{% block head %}
    {{ block.super }}
    <style>
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2em;}
        .section { border: 1px solid #ccc; padding: 1em; margin-bottom: 2em; background-color: white; border-radius: 8px;}
        .form-group { margin-bottom: 1em; }
        label { display: block; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 0.8em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .action-button { padding: 5px 10px; font-size: 14px; }
        #camp-map {
            height: 350px;
            margin-top: 1em;
            margin-bottom: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .address-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .address-group textarea {
            flex-grow: 1;
        }
        .address-group button {
            width: auto;
            flex-shrink: 0;
        }
    </style>
{% endblock %}

{% block ngo_content %}
    <h2>Manage Donation Camps</h2>
    <p>Use this page to create new camps and manage your existing ones.</p>

    <div class="section">
        <h3>Create a New Donation Camp</h3>
        <form method="POST" action="{% url 'ngo_manage_camps' %}">
            {% csrf_token %}
            
            {{ form.latitude }}
            {{ form.longitude }}

            <div class="form-group">
                {{ form.name.label_tag }}
                {{ form.name }}
            </div>
            
            <div class="form-group">
                {{ form.location_address.label_tag }}
                <div class="address-group">
                    {{ form.location_address }}
                    <button type="button" onclick="findAddressOnMap()">Find</button>
                </div>
            </div>

            <div id="camp-map"></div>
            <small>Type an address and click "Find", or click on the map to set the location.</small>

            <div class="form-group" style="margin-top: 1em;">
                {{ form.start_time.label_tag }}
                {{ form.start_time }}
            </div>
            <button type="submit">Create Camp</button>
        </form>
    </div>

    <div class="section">
        <h3>Donations Pending Verification</h3>
        <table>
            <thead>
                <tr><th>From</th><th>Food</th><th>Volunteer</th><th>Delivered To</th><th>Action</th></tr>
            </thead>
            <tbody>
                {% for donation in donations_to_verify %}
                <tr>
                    <td>{{ donation.restaurant.restaurant_name }}</td>
                    <td>{{ donation.food_description }}</td>
                    <td>{{ donation.assigned_volunteer.full_name }}</td>
                    <td>{{ donation.target_camp.name }}</td>
                    <td>
                        <form action="{% url 'confirm_delivery' donation.pk %}" method="POST" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-button">Confirm Delivery</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5">There are no deliveries awaiting your verification.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>My Active Camps</h3>
        <table>
            <thead>
                <tr><th>Name</th><th>Location</th><th>Starts</th><th>Action</th></tr>
            </thead>
            <tbody>
                {% for camp in active_camps %}
                <tr>
                    <td>{{ camp.name }}</td>
                    <td>{{ camp.location_address }}</td>
                    <td>{{ camp.start_time|date:"d M Y, H:i" }}</td>
                    <td>
                        <form action="{% url 'mark_camp_as_completed' camp.pk %}" method="POST" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-button">Mark as Completed</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4">You have no active camps.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>My Completed Camps</h3>
        <table>
            <thead>
                <tr><th>Name</th><th>Location</th><th>Completed At</th></tr>
            </thead>
            <tbody>
                {% for camp in completed_camps %}
                <tr>
                    <td>{{ camp.name }}</td>
                    <td>{{ camp.location_address }}</td>
                    <td>{{ camp.completed_at|date:"d M Y, H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3">You have no completed camps yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <script>
        // Initialize map centered on Delhi
        const map = L.map('camp-map').setView([28.6306, 77.2762], 12); // Centered on Laxmi Nagar
        let marker = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const latField = document.getElementById('id_latitude');
        const lonField = document.getElementById('id_longitude');
        const addressField = document.getElementById('id_location_address');

        function updateMarkerAndFields(lat, lon, address = null) {
            latField.value = lat;
            lonField.value = lon;
            if (address) {
                addressField.value = address;
            }
            if (marker) {
                marker.setLatLng([lat, lon]);
            } else {
                marker = L.marker([lat, lon]).addTo(map);
            }
            map.setView([lat, lon], 15);
        }

        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || 'Could not find address';
                    updateMarkerAndFields(lat, lon, address);
                });
        });

        function findAddressOnMap() {
            const address = addressField.value;
            if (!address) {
                alert("Please enter an address to find.");
                return;
            }
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;
                        updateMarkerAndFields(lat, lon);
                    } else {
                        alert("Address not found.");
                    }
                });
        }
    </script>
{% endblock %}