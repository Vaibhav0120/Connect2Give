{% extends 'base.html' %}

{% block title %}Connect2Give - Home{% endblock %}

{% block head %}
    <style>
        #home-map { 
            height: 500px; 
            margin-top: 2em; 
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .welcome-section {
            padding: 2em;
            background-color: white;
            border-radius: 8px;
            text-align: center;
        }
    </style>
{% endblock %}

{% block content %}

    {% if user.is_authenticated %}
        {# This content is shown ONLY to logged-in users #}
        <div class="welcome-section">
            <h1>Welcome back, {{ user.username }}!</h1>
            <p>You are logged in as a: <strong>{{ user.get_user_type_display }}</strong>.</p>
            
            {% if user.user_type == 'RESTAURANT' %}
                <a href="{% url 'restaurant_dashboard' %}"><button>Go to My Dashboard</button></a>
            {% elif user.user_type == 'NGO' %}
                <a href="{% url 'ngo_dashboard' %}"><button>Go to My Dashboard</button></a>
            {% elif user.user_type == 'VOLUNTEER' %}
                <a href="{% url 'volunteer_dashboard' %}"><button>Go to My Dashboard</button></a>
            {% else %} {# For Admins #}
                 <p>Welcome to the site administration area.</p>
            {% endif %}
            
            <br><br>
            <hr>
            <br>
            <a href="{% url 'logout' %}"><button>Logout</button></a>
        </div>

    {% else %}
        {# This content is shown ONLY to guests (not logged-in users) #}
        <div class="welcome-section">
            <h1>Welcome to Connect2Give</h1>
            <p>The platform connecting restaurants with surplus food to NGOs and volunteers who can deliver it to those in need.</p>
            <br>
            <a href="{% url 'login_page' %}"><button>Login</button></a>
            <a href="{% url 'register_step_1' %}"><button>Register</button></a>
        </div>

        <div id="home-map"></div>
    {% endif %}

{% endblock %}


{% block scripts %}
    {% if not user.is_authenticated %}
        <script>
            // This script will only run for logged-out users who can see the map div

            // Initialize the map and set its view to your location, Delhi
            const map = L.map('home-map').setView([28.644800, 77.216721], 11);

            // Add a tile layer from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Parse the data passed from the Django view
            const camps = JSON.parse('{{ camps_map_data|safe }}');

            // Create a custom icon for camps
            const campIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/931/931949.png',
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38]
            });

            // Add Camp Markers to the Map
            if (camps.length > 0) {
                 camps.forEach(camp => {
                    const marker = L.marker([camp.lat, camp.lon], { icon: campIcon }).addTo(map);
                    marker.bindPopup(
                        `<b>Camp: ${camp.name}</b><br>` +
                        `NGO: ${camp.ngo}<br>` +
                        `Address: ${camp.address}<br>` +
                        `Starts: ${camp.start}`
                    );
                });
            } else {
                // Optionally, add a marker for Delhi if no camps are active
                L.marker([28.644800, 77.216721])
                    .addTo(map)
                    .bindPopup('Connect2Give is active in Delhi! No camps in the last 24 hours.')
                    .openPopup();
            }
        </script>
    {% endif %}
{% endblock %}