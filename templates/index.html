{% extends "base.html" %}
{% load static %}
{% load portal_extras %} {# <-- LOAD THE NEW TEMPLATE TAGS #}

{% block title %}Connect2Give - Home{% endblock %}

{% block head %}
    <style>
        /* Minimal page-specific styles */
        .welcome-section {
            padding: 4em 2em;
            background-color: var(--bg-card);
            border-radius: var(--radius);
            text-align: center;
            margin-top: 2rem;
        }
        #home-map { 
            height: 500px; 
            margin-top: 2em;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
    </style>
{% endblock %}

{% block content %}

    {% if user.is_authenticated %}
        <div class="welcome-section">
            <h1>Welcome back, {{ user.username }}!</h1>
            <p>You are logged in as a: <strong>{{ user.get_user_type_display }}</strong>.</p>
            <br>
            {# --- THE FIX IS HERE --- #}
            <a href="{% get_dashboard_url user %}" class="btn">Go to My Dashboard</a>
            {# --- END OF FIX --- #}
            <a href="{% url 'logout' %}" class="btn btn-secondary" style="margin-left: 1rem;">Logout</a>
        </div>

    {% else %}
        <div class="welcome-section">
            <h1>Welcome to Connect2Give</h1>
            <p>The platform connecting restaurants with surplus food to NGOs and volunteers who can deliver it to those in need.</p>
            <br>
            <a href="{% url 'login_page' %}" class="btn">Login</a>
            <a href="{% url 'register_step_1' %}" class="btn btn-secondary" style="margin-left: 1rem;">Register</a>
        </div>
        <div id="home-map"></div>
    {% endif %}

{% endblock %}

{% block scripts %}
    {{ block.super }}
    {% if not user.is_authenticated %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const map = L.map('home-map').setView([28.6448, 77.2167], 11); // Centered on Delhi
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                const camps = JSON.parse('{{ camps_map_data|safe }}');
                const restaurants = JSON.parse('{{ restaurants_map_data|safe }}');

                const campIcon = L.icon({
                    iconUrl: 'https://placehold.co/38x38/10b981/FFFFFF?text=C',
                    iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38]
                });
                const restaurantIcon = L.icon({
                    iconUrl: 'https://placehold.co/38x38/3b82f6/FFFFFF?text=R',
                    iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38]
                });

                restaurants.forEach(r => {
                    L.marker([r.lat, r.lon], { icon: restaurantIcon }).addTo(map)
                     .bindPopup(`<b>${r.name}</b><br>${r.address}`);
                });

                camps.forEach(camp => {
                    L.marker([camp.lat, camp.lon], { icon: campIcon }).addTo(map)
                     .bindPopup(`<b>Camp: ${camp.name}</b><br>NGO: ${camp.ngo}<br>Address: ${camp.address}<br>Starts: ${camp.start}`);
                });
            });
        </script>
    {% endif %}
{% endblock %}