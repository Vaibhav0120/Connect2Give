{% extends 'base.html' %}
{% load static %}

{% block title %}Register (Step 2 of 2) - Connect2Give{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
    <div class="form-container">
        <h1>Complete Your Profile</h1>
        <p>Step 2 of 2: Profile Information</p>
        <hr>

        <form action="{% url 'register_step_2' %}" method="POST">
            {% csrf_token %}
            
            <input type="hidden" name="latitude" id="id_latitude">
            <input type="hidden" name="longitude" id="id_longitude">

            {% if user_type == 'RESTAURANT' %}
                <h3>Restaurant Information</h3>
                <div class="form-group">
                    <label for="restaurant_name">Restaurant Name:</label>
                    <input type="text" name="restaurant_name" required>
                </div>
                <div class="form-group">
                    <label for="restaurant_phone_number">Phone Number:</label>
                    <input type="text" name="restaurant_phone_number" required>
                </div>
            {% elif user_type == 'NGO' %}
                <h3>NGO Information</h3>
                <div class="form-group">
                    <label for="ngo_name">NGO Name:</label>
                    <input type="text" name="ngo_name" required>
                </div>
                <div class="form-group">
                    <label for="registration_number">Registration Number:</label>
                    <input type="text" name="registration_number" required>
                </div>
                <div class="form-group">
                    <label for="contact_person">Contact Person:</label>
                    <input type="text" name="contact_person" required>
                </div>
            {% elif user_type == 'VOLUNTEER' %}
                <h3>Volunteer Information</h3>
                <div class="form-group">
                    <label for="full_name">Full Name:</label>
                    <input type="text" name="full_name" required>
                </div>
                <div class="form-group">
                    <label for="phone_number">Phone Number:</label>
                    <input type="text" name="phone_number">
                </div>
                <div class="form-group">
                    <label for="skills">Skills (e.g., Driving, Cooking):</label>
                    <input type="text" name="skills">
                </div>
            {% endif %}

            <hr>
            <h3>Set Your Primary Address & Location</h3>
            <div class="form-group">
                <label for="address">Address:</label>
                <div class="address-group">
                    <textarea name="address" id="id_address" rows="3" required></textarea>
                    <button type="button" onclick="findAddressOnMap()">Find</button>
                </div>
            </div>
            <div id="location-map"></div>
            <small>Type your address and click "Find", or click on the map to set your location.</small>

            <br><br>
            <button type="submit">Complete Registration</button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('location-map').setView([28.6448, 77.2167], 11); // Delhi
            let marker = null;
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const latField = document.getElementById('id_latitude');
            const lonField = document.getElementById('id_longitude');
            const addressField = document.getElementById('id_address');

            function updateMarkerAndFields(lat, lon, address = null) {
                latField.value = lat;
                lonField.value = lon;
                if (address) addressField.value = address;
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon]).addTo(map);
                }
                map.setView([lat, lon], 15);
            }

            map.on('click', function(e) {
                const { lat, lng } = e.latlng;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                    .then(res => res.json())
                    .then(data => updateMarkerAndFields(lat, lng, data.display_name));
            });

            window.findAddressOnMap = function() {
                const address = addressField.value;
                if (!address) { alert("Please enter an address."); return; }
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.length > 0) {
                            updateMarkerAndFields(data[0].lat, data[0].lon);
                        } else {
                            alert("Address not found.");
                        }
                    });
            }
        });
    </script>
{% endblock %}
