{% extends 'ngo/base.html' %}

{% block title %}Manage Camps - {{ block.super }}{% endblock %}

{% block page_title %}Manage Camps{% endblock %}
{% block page_description %}Create new camps and manage your existing ones{% endblock %}

{% block ngo_content %}
    <div class="camps-container">
        {% if messages %}
            {% for message in messages %}
                <div class="success-message">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <div class="tab-navigation">
            <button class="tab-button {% if not active_tab %}active{% endif %}" onclick="switchTab(event, 'create-camp')">Create Camp</button>
            <button class="tab-button {% if active_tab == 'history' %}active{% endif %}" onclick="switchTab(event, 'camps-history')">Camps History</button>
            <button class="tab-button {% if active_tab == 'verification' %}active{% endif %}" onclick="switchTab(event, 'donation-verification')">Donation Verification</button>
        </div>

        <div id="create-camp" class="tab-content {% if not active_tab %}active{% endif %}">
            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Create a New Donation Camp</h3>
                <form method="POST" action="{% url 'ngo_manage_camps' %}">
                    {% csrf_token %}
                    {{ form.latitude }}
                    {{ form.longitude }}

                    <div class="form-group">
                        {{ form.name.label_tag }}
                        {{ form.name }}
                    </div>
                    
                    <div class="form-group">
                        {{ form.location_address.label_tag }}
                        <div class="address-group">
                            {{ form.location_address }}
                            <button type="button" onclick="findAddressOnMap()">Find Location</button>
                        </div>
                    </div>

                    <div id="camp-map"></div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
                        Type an address and click "Find Location", or click on the map to set the location.
                    </p>

                    <div class="form-group">
                        {{ form.start_time.label_tag }}
                        {{ form.start_time }}
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="submit">Create Camp</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="camps-history" class="tab-content {% if active_tab == 'history' %}active{% endif %}">
            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Active Camps</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Camp Name</th>
                            <th>Location</th>
                            <th>Start Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for camp in active_camps %}
                        <tr>
                            <td><strong>{{ camp.name }}</strong></td>
                            <td>{{ camp.location_address }}</td>
                            <td>{{ camp.start_time|date:"d M Y, H:i" }}</td>
                            <td><span style="color: var(--accent-green); font-weight: 500;">Active</span></td>
                            <td>
                                <form action="{% url 'mark_camp_as_completed' camp.pk %}" method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button">Mark as Completed</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">You have no active camps at the moment.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Completed Camps</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Camp Name</th>
                            <th>Location</th>
                            <th>Completed At</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for camp in completed_camps %}
                        <tr>
                            <td><strong>{{ camp.name }}</strong></td>
                            <td>{{ camp.location_address }}</td>
                            <td>{{ camp.completed_at|date:"d M Y, H:i" }}</td>
                            <td><span style="color: var(--text-muted); font-weight: 500;">Completed</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="empty-state">You have no completed camps yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="donation-verification" class="tab-content {% if active_tab == 'verification' %}active{% endif %}">
            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Donations Pending Verification</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Restaurant</th>
                            <th>Food Description</th>
                            <th>Volunteer</th>
                            <th>Delivered To</th>
                            <th>Delivered At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for donation in donations_to_verify %}
                        <tr>
                            <td><strong>{{ donation.restaurant.restaurant_name }}</strong></td>
                            <td>{{ donation.food_description }}</td>
                            <td>{{ donation.assigned_volunteer.full_name }}</td>
                            <td>{{ donation.target_camp.name }}</td>
                            <td>{{ donation.delivered_at|date:"d M Y, H:i" }}</td>
                            <td>
                                <form action="{% url 'confirm_delivery' donation.pk %}" method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button">Confirm Delivery</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="empty-state">There are no deliveries awaiting your verification.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        let map; // Declare map variable in a broader scope

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize map centered on Delhi, as you live there
            map = L.map('camp-map').setView([28.6139, 77.2090], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let marker = null;
            const latField = document.getElementById('id_latitude');
            const lonField = document.getElementById('id_longitude');
            const addressField = document.getElementById('id_location_address');

            function updateMarkerAndFields(lat, lon, address = null) {
                latField.value = lat;
                lonField.value = lon;
                if (address) {
                    addressField.value = address;
                }
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon]).addTo(map);
                }
                map.setView([lat, lon], 15);
            }

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || 'Could not find address';
                        updateMarkerAndFields(lat, lon, address);
                    });
            });

            // Make findAddressOnMap globally accessible
            window.findAddressOnMap = function() {
                const address = addressField.value;
                if (!address) {
                    alert("Please enter an address to find.");
                    return;
                }
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lat = data[0].lat;
                            const lon = data[0].lon;
                            updateMarkerAndFields(lat, lon);
                        } else {
                            alert("Address not found.");
                        }
                    });
            }
        });

        // Tab switching functionality
        function switchTab(event, tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Fix for map not rendering correctly in a hidden tab
            if (tabId === 'create-camp') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 10); // A small delay is sometimes needed
            }
        }
    </script>
{% endblock %}